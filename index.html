<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSB Timetable Picker</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #242424;
            color: rgba(255, 255, 255, 0.87);
            font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
            overflow-y: scroll;
        }

        #root {
            max-width: 80rem;
            margin: 0 auto;
            padding-top: 2rem;
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }

        ::-webkit-scrollbar-track {
            background: #333;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 0.25rem;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(0.25rem);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- DEMO DATA ---
        const DEMO_DATA = [
            {
                title: "info",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "Pondƒõl√≠",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 4, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:30", teacherShortNamesString: "Kliknƒõte sem prav√Ωm tlaƒç√≠tkem...", teacherFullNamesString: "V√Ωbornƒõ! Zde se v√°m zobraz√≠ cel√° jm√©na vyuƒçuj√≠c√≠ch. Prozkoumejte dal≈°√≠ pol√≠ƒçka s ikonou ‚ìò a seznamte se s Timetablem :)", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 101, roomFullCodesString: "" } }
                                        ]
                                    },
                                    {
                                        items: [
                                            { used: true, duration: 4, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:30", teacherShortNamesString: "...nebo dlouze stisknƒõte", teacherFullNamesString: "V√Ωbornƒõ! Zde se v√°m zobraz√≠ cel√° jm√©na vyuƒçuj√≠c√≠ch. Prozkoumejte dal≈°√≠ pol√≠ƒçka s ikonou ‚ìò a seznamte se s Timetablem :)", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 102, roomFullCodesString: "" } }
                                        ]
                                    }

                                ]
                            },
                            {
                                title: "ƒåtvrtek",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "ƒåerven√° ƒç√°ra ‚ìò", teacherFullNamesString: "To je jenom ukazatel aktu√°ln√≠ho ƒçasu xdd", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 103, roomFullCodesString: "" } }
                                        ]
                                    }
                                ]
                            },
                            {
                                title: "P√°tek",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:45", teacherShortNamesString: "M√≠stnosti ‚ìò", teacherFullNamesString: "Kliknut√≠m na odkaz n√≠≈æe zobraz√≠te mapu s lokac√≠ m√≠stnosti:", subjectAbbrev: "INFO", lecture: false, concreteActivityId: 104, roomFullCodesString: "PORUA1" } }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "kolize",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "√öter√Ω",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "Zvolen√≠ hodiny ‚ìò", teacherFullNamesString: "Kliknut√≠m lev√Ωm tlaƒç√≠tkem nebo ≈•uknut√≠m zvol√≠te hodinu p≈ôedmƒõtu. Z√°rove≈à se skryj√≠ ostatn√≠ hodiny tohoto p≈ôedmƒõtu a hodiny kter√© zaƒç√≠naj√≠ ve stejn√Ω ƒças. (Jak je zobrazit se dozv√≠te v pol√≠ƒçku n√≠≈æe)", subjectAbbrev: "KOLIZE", lecture: false, concreteActivityId: 201, roomFullCodesString: "" } }
                                        ]
                                    },
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "Zobraz. skryt√Ωch ‚ìò", teacherFullNamesString: "Pro odkryt√≠ kliknƒõte na p≈ôep√≠naƒç pod nadpisem str√°nky. Zobraz√≠ se v√°m v≈°echny hodiny, kter√© koliduj√≠ s vybranou hodinou, nebo ostatn√≠ hodiny z vybran√©ho p≈ôedmƒõtu.", subjectAbbrev: "KOLIZE", lecture: false, concreteActivityId: 202, roomFullCodesString: "" } }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "Smazat",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "Pondƒõl√≠",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "13:15", scheduleWindowEndTime: "15:00", teacherShortNamesString: "Smazat p≈ôedmƒõt ‚ìò", teacherFullNamesString: "P≈ôi najet√≠ na p≈ôedmƒõt v nab√≠dce naho≈ôe se v√°m uk√°≈æe k≈ô√≠≈æek. T√≠m m≈Ø≈æete p≈ôedmƒõt smazat (nebojte, m≈Ø≈æete ho pak znovu nahr√°t)", subjectAbbrev: "SMAZAT", lecture: true, concreteActivityId: 301, roomFullCodesString: "" } }
                                        ]
                                    }
                                ]
                            },
                            {
                                title: "P√°tek",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "16:45", scheduleWindowEndTime: "19:15", teacherShortNamesString: "Reset ‚ìò", teacherFullNamesString: "Pokud byste chtƒõli znovu zobrazit DEMO nebo nahr√°t jin√© p≈ôedmƒõty, m≈Ø≈æete vyu≈æ√≠t tlaƒç√≠tko \"Smazat v≈°e a resetovat\" v menu Spr√°va rozvrhu.", subjectAbbrev: "SMAZAT", lecture: true, concreteActivityId: 302, roomFullCodesString: "" } }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "demo1",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "√öter√Ω",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "16:45", scheduleWindowEndTime: "17:30", teacherShortNamesString: "Zobraz. p≈ôedmƒõt≈Ø ‚ìò", teacherFullNamesString: "P≈ôi kliknut√≠ na p≈ôedmƒõt v horn√≠ nab√≠dce zobraz√≠te v≈°echny jeho hodiny. Zvolen√© hodiny z jin√Ωch p≈ôedmƒõt≈Ø se v√°m zde tak√© objev√≠.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 302, roomFullCodesString: "" } }
                                        ]
                                    }
                                ]
                            },
                            {
                                title: "St≈ôeda",
                                queues: [
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "08:00", scheduleWindowEndTime: "10:30", teacherShortNamesString: "P≈ôedn√°≈°ka ‚ìò", teacherFullNamesString: "P≈ôedn√°≈°kov√° hodina je oznaƒçena p√≠smenem \"P\" vpravo naho≈ôe a m√° ƒçervenou barvu.", subjectAbbrev: "DEMO1", lecture: true, concreteActivityId: 303, roomFullCodesString: "" } }
                                        ]
                                    },
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "09:00", scheduleWindowEndTime: "11:30", teacherShortNamesString: "Cviƒçen√≠ ‚ìò", teacherFullNamesString: "Hodina cviƒçen√≠ je oznaƒçena p√≠smenem \"C\" vpravo naho≈ôe a m√° modrou barvu.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 304, roomFullCodesString: "" } }
                                        ]
                                    },
                                    {
                                        items: [
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "12:30", scheduleWindowEndTime: "14:15", teacherShortNamesString: "Povinnosti ‚ìò", teacherFullNamesString: "U p≈ôedmƒõtu v horn√≠ nab√≠dce se zobraz√≠ zda si m√°te zvolit p≈ôedn√°≈°ku a/nebo cviƒçen√≠. P≈ôi zvolen√≠ se ikona probarv√≠. (Standartnƒõ 1 p≈ôedn√°≈°ka a/nebo cviƒçen√≠. Jinak bych musel k√≥d dost upravit üíÄ)", subjectAbbrev: "DEMO1", lecture: true, concreteActivityId: 305, roomFullCodesString: "" } }
                                        ]
                                    },
                                    {
                                        items: [    
                                            { used: true, duration: 3, dto: { scheduleWindowBeginTime: "14:15", scheduleWindowEndTime: "15:45", teacherShortNamesString: "Spr√°va rozvrhu ‚ìò", teacherFullNamesString: "Kliknut√≠m na tlaƒç√≠tko pod nadpisem str√°nky se dostanete do menu, kde m≈Ø≈æete nahr√°vat sv√© p≈ôedmƒõty (je zde i odkaz na n√°povƒõdu). Va≈°e soubory automaticky p≈ôep√≠≈°ou DEMO, tak≈æe nemus√≠te nic mazat.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 306, roomFullCodesString: "" } }
                                        ]
                                    }

                                ]
                            }
                        ]
                    }
                }
            }
        ];

        const Modal = ({ isOpen, onClose, children, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                            <i className="fas fa-times text-xl"></i>
                        </button>
                        <h2 className="text-2xl font-bold mb-4 text-white">{title}</h2>
                        {children}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [timetableData, setTimetableData] = useState(() => {
                const saved = localStorage.getItem("vsb_timetable_data");
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        return parsed && parsed.length > 0 ? parsed : DEMO_DATA;
                    } catch (e) { return DEMO_DATA; }
                }
                return DEMO_DATA;
            });

            const [selectedEntries, setSelectedEntries] = useState(() => {
                const savedEntries = localStorage.getItem("selectedEntries");
                return new Set(savedEntries ? JSON.parse(savedEntries) : []);
            });
            const [selectedSubjects, setSelectedSubjects] = useState(() => {
                const savedSubjects = localStorage.getItem("selectedSubjects");
                return new Set(savedSubjects ? JSON.parse(savedSubjects) : []);
            });

            const [showUnusedClasses, setShowUnusedClasses] = useState(
                localStorage.getItem("showUnusedClasses") === "true"
            );

            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);

            const [tooltip, setTooltip] = useState(null);

            useEffect(() => {
                localStorage.setItem("vsb_timetable_data", JSON.stringify(timetableData));
            }, [timetableData]);

            useLayoutEffect(() => {
                if (tooltip) {
                    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                    document.body.style.overflow = 'hidden';
                    document.documentElement.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.documentElement.style.overflow = '';
                }
                return () => {
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.documentElement.style.overflow = '';
                };
            }, [tooltip]);

            useEffect(() => {
                if (tooltip && tooltip.room && !tooltip.roomUrl) {
                    const controller = new AbortController();
                    const fetchRoom = async () => {
                        try {
                            // Pou≈æijeme CORS proxy, proto≈æe API mapy.vsb.cz neumo≈æ≈àuje p≈ô√≠m√© vol√°n√≠ z prohl√≠≈æeƒçe (CORS error)
                            const targetUrl = `https://mapy.vsb.cz/maps/api/v0/rooms/autocomplete?query=${encodeURIComponent(tooltip.room)}&language=cs`;
                            const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(targetUrl)}`, { signal: controller.signal });
                            if (res.ok) {
                                const data = await res.json();
                                if (Array.isArray(data) && data.length > 0) {
                                    const id = data[0].id;
                                    const url = `https://mapy.vsb.cz/maps/?id=${id}&type=rooms&lang=cs`;
                                    console.log(`Fetched room URL for ${tooltip.room}: ${url}`);
                                    setTooltip(prev => (prev && prev.room === tooltip.room ? { ...prev, roomUrl: url } : prev));
                                }
                            }
                        } catch (e) { }
                    };
                    fetchRoom();
                    return () => controller.abort();
                }
            }, [tooltip]);

            const timeSlots = [
                "07:15-08:00", "08:00-08:45", "09:00-09:45", "09:45-10:30", "10:45-11:30",
                "11:30-12:15", "12:30-13:15", "13:15-14:00", "14:15-15:00", "15:00-15:45",
                "16:00-16:45", "16:45-17:30", "17:45-18:30", "18:30-19:15",
            ];

            const colors = ["bg-green-700", "bg-fuchsia-500", "bg-orange-500", "bg-yellow-500", "bg-purple-700", "bg-pink-900", "bg-indigo-500", "bg-violet-900"];
            const subjectColors = {};


            const SLOT_MIN = 50;
            const SLOT_MAX = 75;

            const calculateSlotWidth = (viewportWidth) => {
                const NUM_SLOTS = timeSlots.length +1
                const idealSlotWidth = (viewportWidth-8) / NUM_SLOTS;
                return Math.max(SLOT_MIN, Math.min(SLOT_MAX, idealSlotWidth));
            };

            const [slotWidth, setSlotWidth] = useState(() => {
                const w = typeof window !== 'undefined' ? window.innerWidth : 1024;
                return calculateSlotWidth(w);
            });

            useEffect(() => {
                const onResize = () => {
                    setSlotWidth(calculateSlotWidth(window.innerWidth));
                };
                window.addEventListener('resize', onResize);
                return () => window.removeEventListener('resize', onResize);
            }, []);

            const getCurrentTimePosition = () => {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const TIME_SLOT_WIDTH = slotWidth;

                for (let i = 0; i < timeSlots.length; i++) {
                    const [start, end] = timeSlots[i].split("-").map((t) => {
                        const [h, m] = t.split(":").map(Number);
                        return h * 60 + m;
                    });

                    if (currentMinutes < start) {
                        if (i === 0) {
                            return 1;
                        }
                        return i * TIME_SLOT_WIDTH;
                    }

                    if (currentMinutes >= start && currentMinutes < end) {
                        const slotProgress = (currentMinutes - start) / (end - start);
                        const position = i * TIME_SLOT_WIDTH + slotProgress * TIME_SLOT_WIDTH;
                        return position === 0 ? 1 : position;
                    }

                }

                return timeSlots.length * TIME_SLOT_WIDTH;
            };

            const [currentTimePosition, setCurrentTimePosition] = useState(getCurrentTimePosition());

            // Update position immediately when slot width changes (responsive resize)
            useEffect(() => {
                setCurrentTimePosition(getCurrentTimePosition());
            }, [slotWidth]);

            // Update position every 60 seconds for time passage
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTimePosition(getCurrentTimePosition());
                }, 60000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                localStorage.setItem("selectedEntries", JSON.stringify(Array.from(selectedEntries)));
            }, [selectedEntries]);

            useEffect(() => {
                localStorage.setItem("selectedSubjects", JSON.stringify(Array.from(selectedSubjects)));
            }, [selectedSubjects]);

            // Handlery
            const handleFileUpload = (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                const promises = files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const json = JSON.parse(e.target.result);
                                const title = file.name.replace(".json", "");
                                resolve({ title, data: json.default || json });
                            } catch (err) { resolve(null); }
                        };
                        reader.readAsText(file);
                    });
                });
                Promise.all(promises).then(results => {
                    const validData = results.filter(item => item !== null);
                    setTimetableData(prev => {
                        // If current data is DEMO, replace it with new uploads
                        const isDEMO = prev.length === DEMO_DATA.length && prev.every((item, idx) => item.title === DEMO_DATA[idx].title);
                        if (isDEMO) {
                            return validData;
                        }
                        // Otherwise, append new uploads to existing data
                        const existingTitles = new Set(prev.map(p => p.title));
                        const newData = validData.filter(d => !existingTitles.has(d.title));
                        return [...prev, ...newData];
                    });
                    setIsUploadModalOpen(false);
                });
            };

            const handleDeleteAll = () => {
                // No longer shows alert; instead uses expandable button in modal
            };

            // Two-step delete all: perform deletion without browser confirm
            const performDeleteAll = () => {
                setTimetableData(DEMO_DATA);
                setSelectedEntries(new Set());
                setSelectedSubjects(new Set());
                localStorage.removeItem("vsb_timetable_data");
                setIsUploadModalOpen(false);
                setConfirmDeleteAll(false);
            };

            const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);

            const handleDeleteSubject = (e, subjectName) => {
                e.stopPropagation();
                // deprecated: kept for compatibility but no confirm here
            }

            // Two-step delete: perform deletion without browser confirm
            const performDeleteSubject = (subjectName) => {
                setTimetableData(prev => prev.filter(fileItem => {
                    const containsSubject = fileItem.title.includes(subjectName) ||
                        (fileItem.data?.subjectScheduleTable?.days || []).some(d =>
                            d.queues.some(q => q.items.some(it => it.dto?.subjectAbbrev === subjectName))
                        );
                    return !containsSubject;
                }));
                setSelectedSubjects(prev => {
                    const newSet = new Set(prev);
                    newSet.delete(subjectName);
                    return newSet;
                });
                // clear any pending confirm state
                setConfirmDeleteSubject(null);
            }

            const [confirmDeleteSubject, setConfirmDeleteSubject] = useState(null);

            // --- LONG PRESS LOGIC ---
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);
            const touchStartPos = useRef({ x: 0, y: 0 });

            const handleTouchStart = (e, subject) => {
                isLongPress.current = false;
                const touch = e.touches[0];
                const x = touch.clientX;
                const y = touch.clientY;
                
                touchStartPos.current = { x, y };

                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    setTooltip({
                        x: x,
                        y: y,
                        teacher: subject.teacherFull,
                        room: subject.roomId,
                        isTouch: true
                    });
                }, 500);
            };

            const handleTouchEnd = (e) => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
                if (isLongPress.current) {
                    if (e.cancelable) e.preventDefault();
                    setTimeout(() => { isLongPress.current = false; }, 200);
                }
            };

            const handleTouchMove = (e) => {
                if (longPressTimer.current) {
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - touchStartPos.current.x);
                    const moveY = Math.abs(touch.clientY - touchStartPos.current.y);
                    
                    if (moveX > 10 || moveY > 10) {
                        clearTimeout(longPressTimer.current);
                        longPressTimer.current = null;
                    }
                }
            };

            // --- V√ùPOƒåET KONCE HODINY ---
            const calculateEndTime = (startTime, duration) => {

                startTime = startTime.substring(0, 5);
                // Najdeme index, kde zaƒç√≠n√° hodina (nap≈ô. "09:00" -> index 2)
                const startIndex = timeSlots.findIndex(slot => slot.startsWith(startTime));

                if (startIndex === -1) return "??:-1"; // Fallback pokud ƒças nesed√≠

                // Spoƒç√≠t√°me index konce
                // Pokud zaƒç√≠n√°me na indexu 2 a trv√°me 2 hodiny, chceme sloty 2 a 3.
                // Konec je konec slotu 3.
                const endIndex = startIndex + duration - 1;

                if (endIndex < timeSlots.length) {
                    return timeSlots[endIndex].split("-")[1]; // Vr√°t√≠ ƒç√°st za pomlƒçkou
                }

                // Fallback pro nestandardn√≠ ƒçasy
                return "??:??";
            };

            // Data Processing
            const formatSchedule = (scheduleTable) => {
                const formatted = [];
                if (!scheduleTable || !scheduleTable.days) return [];
                scheduleTable.days.forEach((day) => {
                    day.queues.forEach((queue) => {
                        queue.items.forEach((item) => {
                            if (item.used && item.dto) {
                                const duration = item.duration || 2;
                                formatted.push({
                                    day: day.title,
                                    startTime: item.dto.scheduleWindowBeginTime,
                                    endTime: calculateEndTime(item.dto.scheduleWindowBeginTime, duration),
                                    teacher: item.dto.teacherShortNamesString,
                                    teacherFull: item.dto.teacherFullNamesString,
                                    abbreviation: item.dto.subjectAbbrev,
                                    isLecture: item.dto.lecture,
                                    duration: duration,
                                    activityId: item.dto.concreteActivityId,
                                    roomId: item.dto.roomFullCodesString,
                                });
                            }
                        });
                    });
                });
                return formatted;
            };

            const allEntries = timetableData.map(({ data }) => formatSchedule(data.subjectScheduleTable)).flat();

            let pomI = 0;
            allEntries.forEach((entry) => {
                if (!subjectColors[entry.abbreviation]) {
                    subjectColors[entry.abbreviation] = colors[pomI % colors.length];
                    pomI++;
                }
            });

            // Tetris Layout Logic
            const calculateLayout = (entries) => {
                const sorted = [...entries].sort((a, b) => {
                    if (a.startTime !== b.startTime) return a.startTime.localeCompare(b.startTime);
                    return b.duration - a.duration;
                });

                const rows = [];

                const positioned = sorted.map(entry => {
                    let rowIndex = -1;
                    for (let r = 0; r < rows.length; r++) {
                        if (entry.startTime >= rows[r]) {
                            rowIndex = r;
                            rows[r] = entry.endTime;
                            break;
                        }
                    }
                    if (rowIndex === -1) {
                        rowIndex = rows.length;
                        rows.push(entry.endTime);
                    }
                    return { ...entry, visualRowIndex: rowIndex };
                });

                return {
                    items: positioned,
                    rowCount: Math.max(1, rows.length)
                };
            };

            const pickClass = (entry) => {
                setSelectedEntries((prev) => {
                    const newSet = new Set(prev);
                    const key = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                    if (newSet.has(key)) newSet.delete(key);
                    else newSet.add(key);
                    return newSet;
                });
            };

            const toggleSubject = (subject) => {
                setSelectedSubjects((prev) => {
                    const newSet = new Set(prev);
                    if (newSet.has(subject)) newSet.delete(subject);
                    else newSet.add(subject);
                    return newSet;
                });
            };

            const groupAndFilterEntries = () => {
                const grouped = { Pondƒõl√≠: [], √öter√Ω: [], St≈ôeda: [], ƒåtvrtek: [], P√°tek: [] };

                allEntries.forEach((entry) => {
                    const key = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                    const isSelected = selectedEntries.has(key);
                    const isSubjectVisible = selectedSubjects.size === 0 || selectedSubjects.has(entry.abbreviation);
                    const isCollisionVisible = showUnusedClasses || !isEntryHidden(entry);

                    if ((isSubjectVisible && isCollisionVisible) || isSelected) {
                        if (grouped[entry.day]) grouped[entry.day].push(entry);
                    }
                });
                return grouped;
            }

            const uniqueSubjects = [...new Set(allEntries.map((entry) => `${entry.abbreviation}~${entry.isLecture ? "P" : "C"}`))];
            const subjectTypesMap = uniqueSubjects.reduce((acc, subject) => {
                const [name, type] = subject.split("~");
                if (!acc[name]) acc[name] = [];
                acc[name].push(type);
                return acc;
            }, {});

            const isEntryHidden = (entry) => {
                const entryKey = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                for (const selectedEntryKey of selectedEntries) {
                    // skip comparing the entry against itself (by key)
                    if (selectedEntryKey === entryKey) continue;
                    const selectedEntry = allEntries.find(e => `${e.day}~${e.startTime}~${e.abbreviation}~${e.isLecture}~${e.teacher}` === selectedEntryKey);
                    if (selectedEntry) {
                        if (entry.abbreviation === selectedEntry.abbreviation && entry.isLecture === selectedEntry.isLecture) return true;
                        if (entry.startTime === selectedEntry.startTime && entry.day === selectedEntry.day) return true;
                    }
                }
                return false;
            };

            const getTimeSlotIndex = (time) => {
                return timeSlots.findIndex(slot => slot.startsWith(time)) + 2;
            }

            const toggleUnusedClasses = () => {
                const newVal = !showUnusedClasses;
                setShowUnusedClasses(newVal);
                localStorage.setItem("showUnusedClasses", newVal);
            }

            const groupedData = groupAndFilterEntries();
            const DAY_COL_WIDTH = slotWidth - 4;
            const SLOT_WIDTH = slotWidth;
            const ROW_HEIGHT = 60;
            const TABLE_WIDTH = DAY_COL_WIDTH + (timeSlots.length * SLOT_WIDTH);
            const SCREEN_WIDTH = TABLE_WIDTH + 2;

            const TABLE_MIN_WIDTH = (SLOT_MIN-4) + (timeSlots.length * SLOT_MIN);

            return (
                <div className="flex-1 w-full mx-auto pt-4 flex flex-col items-center" style={{ maxWidth: SCREEN_WIDTH }}>

                    <Modal isOpen={isUploadModalOpen} onClose={() => setIsUploadModalOpen(false)} title="Spr√°va rozvrhu">
                        <div className="flex flex-col gap-6">
                            <div className="flex flex-col items-center">
                                <label className="block text-sm font-medium text-gray-300 mb-2 text-center">Nahr√°t nov√© soubory (.json)</label>
                                <input id="fileInput" type="file" multiple accept=".json" onChange={handleFileUpload} className="hidden" />
                                <label htmlFor="fileInput" className="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer">
                                    <i className="fas fa-upload mr-2"></i> Vybrat soubory
                                </label>
                            </div>
                            <div className="border-t border-gray-600 pt-4">
                                <button
                                    onClick={() => {
                                        if (confirmDeleteAll) {
                                            performDeleteAll();
                                        } else {
                                            setConfirmDeleteAll(true);
                                        }
                                    }}
                                    onMouseLeave={() => {
                                        if (confirmDeleteAll) setConfirmDeleteAll(false);
                                    }}
                                    className={`w-full text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2 transition-all duration-150 ${confirmDeleteAll ? 'bg-red-800' : 'bg-red-600 hover:bg-red-700'}`}
                                >
                                    {confirmDeleteAll ? (
                                        <><i className="fas fa-trash"></i>Opravdu chcete v≈°e smazat a resetovat?</>
                                    ) : (
                                        <><i className="fas fa-trash"></i> Smazat v≈°e a resetovat</>
                                    )}
                                </button>
                            </div>
                        </div>
                    </Modal>

                    <div className="mb-8 mt-2 px-5 w-full flex flex-col gap-3 items-center">
                        <h1 className="text-2xl font-bold text-white w-full text-center">V≈†B Timetable Picker (HTML)</h1>
                        <div className="flex flex-wrap gap-4 items-center w-full justify-center">
                            <label className="inline-flex items-center cursor-pointer bg-gray-800 px-3 py-2 rounded border border-gray-700 hover:bg-gray-700 transition flex-shrink-0">
                                <input type="checkbox" onChange={toggleUnusedClasses} checked={showUnusedClasses} className="sr-only peer" />
                                <div className="relative w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-green-600 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
                                <span className="ml-3 text-sm font-medium text-gray-300 text-nowrap">Zobrazit skryt√© hodiny</span>
                            </label>
                            <button onClick={() => setIsUploadModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white text-nowrap font-bold py-2 px-4 rounded shadow flex items-center gap-2 flex-shrink-0">
                                <i className="fas fa-cog flex-[0 0 auto]"></i><span className="flex-1 text-center">Spr√°va rozvrhu</span>
                            </button>
                        </div>
                    </div>

                    <div className="mb-6 px-5 flex flex-wrap gap-3 w-full justify-center">
                        {Object.entries(subjectTypesMap).map(([name, types]) => (
                            <div key={name} className="relative group">
                                <button onClick={() => toggleSubject(name)} className={`px-4 py-3 border rounded-lg transition-all duration-200 shadow-lg ${selectedSubjects.has(name) ? "bg-gray-700 border-gray-500" : "bg-zinc-800 border-zinc-600 opacity-60 [@media(hover:hover)]:hover:opacity-100"}`}>
                                    <div className={`font-bold ${subjectColors[name]} text-white rounded mb-2 py-1 px-3 text-lg shadow-sm`}>{name}</div>
                                    <div className="flex justify-center gap-2 w-full">
                                        {types.map((type, i) => {
                                            const isSelected = Array.from(selectedEntries).some((el) => {
                                                const split = el.split("~");
                                                return split[2] === name && split[3] === (type === "C" ? "false" : "true");
                                            });
                                            return <div key={name + type + i} className={`inline-block px-2 py-0.5 text-xs rounded font-bold border ${type === "C" ? (isSelected ? "bg-blue-600 border-blue-400 text-white" : "text-blue-400 border-blue-900") : (isSelected ? "bg-red-600 border-red-400 text-white" : "text-red-400 border-red-900")}`}>{type}</div>
                                        })}
                                    </div>
                                </button>
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirmDeleteSubject === name) {
                                            performDeleteSubject(name);
                                        } else {
                                            setConfirmDeleteSubject(name);
                                        }
                                    }}
                                    onMouseLeave={() => {
                                        // collapse confirmation when mouse leaves the button
                                        if (confirmDeleteSubject === name) setConfirmDeleteSubject(null);
                                    }}
                                    className={`absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full flex items-center justify-center shadow-md text-xs transition-all duration-150 ${confirmDeleteSubject === name ? 'px-3 py-1 rounded-full w-auto opacity-100' : `w-6 h-6 ${selectedSubjects.has(name) ? 'opacity-100' : 'opacity-0 [@media(hover:hover)]:group-hover:opacity-100'}`}`}>
                                    {confirmDeleteSubject === name ? 'Smazat?' : <i className="fas fa-times"></i>}
                                </button>
                            </div>
                        ))}
                    </div>

                    

                    <div className="w-full overflow-x-auto">
                        <div style={{ minWidth: TABLE_WIDTH === TABLE_MIN_WIDTH ? TABLE_WIDTH + 20 : TABLE_WIDTH }}>
                            <div className="flex bg-gray-800 border-b-2 border-gray-600" style={{ width: TABLE_WIDTH }}>
                                <div className="flex-none bg-gray-700 flex items-center justify-center font-bold text-gray-400 border-r border-gray-600" style={{ width: DAY_COL_WIDTH }}>Den</div>
                                {timeSlots.map((slot, index) => (
                                    <div key={slot} className={`flex-none h-full py-2 text-center text-xs text-gray-400 border-r border-gray-700/50 flex flex-col justify-center ${index % 2 ? "bg-gray-700/30" : "bg-gray-800"}`} style={{ width: SLOT_WIDTH }}>
                                        {slot.split("-").map((part, i) => <div key={i}>{part}</div>)}
                                    </div>
                                ))}
                            </div>
                        </div>    
                            <div className="relative flex flex-col gap-1 pb-14 select-none" style={{ minWidth: TABLE_WIDTH }}>
                        {currentTimePosition && (
                            <div className="absolute h-full w-0.5 bg-red-500 z-20 pointer-events-none shadow-[0_0_8px_rgba(239,68,68,0.8)]" style={{ left: `${currentTimePosition + DAY_COL_WIDTH}px` }} />
                        )}

                        {["Pondƒõl√≠", "√öter√Ω", "St≈ôeda", "ƒåtvrtek", "P√°tek"].map((day) => {
                            const rawEntries = groupedData[day] || [];
                            const { items: positionedEntries, rowCount } = calculateLayout(rawEntries);

                            return (
                                <div key={day} className="relative bg-gray-800 border-b border-gray-700 grid"
                                    style={{
                                        width: TABLE_WIDTH,
                                        gridTemplateColumns: `${DAY_COL_WIDTH}px repeat(${timeSlots.length}, ${SLOT_WIDTH}px)`,
                                        gridTemplateRows: `repeat(${rowCount}, ${ROW_HEIGHT}px)`
                                    }}>

                                    <div className="col-start-1 flex items-center justify-center bg-sky-900 text-sky-200 font-bold text-lg border-r border-gray-600 z-10"
                                        style={{ gridRow: `1 / span ${rowCount}` }}>
                                        {day.substring(0, 2)}
                                    </div>

                                    <div className="absolute inset-0 pointer-events-none z-0">
                                        {timeSlots.map((_, i) => (
                                            <div key={i} className="absolute top-0 bottom-0 border-r border-gray-700/40" style={{ left: DAY_COL_WIDTH + ((i + 1) * SLOT_WIDTH) }}></div>
                                        ))}
                                    </div>

                                    {positionedEntries.map((subject, index) => {
                                        const key = `${subject.day}~${subject.startTime}~${subject.abbreviation}~${subject.isLecture}~${subject.teacher}`;
                                        const isSelected = selectedEntries.has(key);
                                        const colStart = getTimeSlotIndex(subject.startTime.substring(0, 5));

                                        return (
                                            <div
                                                key={index}
                                                className={`
                                                    relative z-10 m-[2px] border-2 rounded-md cursor-pointer overflow-hidden text-xs
                                                    transition-all duration-150 hover:z-20 hover:shadow-xl hover:scale-105
                                                    ${showUnusedClasses && "select-none"} 
                                                    ${subject.isLecture ? "border-red-800 bg-red-900/80 hover:bg-red-800" : "border-sky-800 bg-sky-900/80 hover:bg-sky-800"} 
                                                    ${isSelected ? `!border-lime-400 ring-1 ring-lime-400 !bg-opacity-100 shadow-md` : ""} 
                                                    ${isEntryHidden(subject) && !isSelected ? "opacity-30 grayscale" : ""}
                                                    ${isSelected && subject.isLecture ? "!bg-red-700" : ""} 
                                                    ${isSelected && !subject.isLecture ? "!bg-sky-700" : ""}
                                                `}
                                                style={{
                                                    gridColumnStart: colStart,
                                                    gridColumnEnd: colStart + subject.duration,
                                                    gridRow: subject.visualRowIndex + 1
                                                }}

                                                onClick={(e) => {
                                                    if (isLongPress.current) return;
                                                    if (!isEntryHidden(subject)) {
                                                        pickClass(subject);
                                                    }
                                                }}

                                                onContextMenu={(e) => {
                                                    e.preventDefault();
                                                    setTooltip({
                                                        x: e.clientX,
                                                        y: e.clientY,
                                                        teacher: subject.teacherFull,
                                                        room: subject.roomId,
                                                        isTouch: false
                                                    });
                                                }}

                                                onTouchStart={(e) => handleTouchStart(e, subject)}
                                                onTouchEnd={handleTouchEnd}
                                                onTouchMove={handleTouchMove}


                                            >
                                                <div className="pl-0.5 py-0.5 pr-2 flex flex-col h-full justify-between">
                                                    <input
                                                        type="checkbox"
                                                        className="hidden"
                                                        checked={isSelected}
                                                        readOnly // P≈ôid√°no, aby React nek≈ôiƒçel, ≈æe input nem√° onChange
                                                        disabled={isEntryHidden(subject)}
                                                    />
                                                    <div className="flex justify-between items-start">
                                                        <span className={`font-bold px-1.5 py-0.5 rounded text-[10px] text-white ${subjectColors[subject.abbreviation]} ${selectedSubjects.has(subject.abbreviation)}`}>
                                                            {subject.abbreviation}
                                                        </span>
                                                        <span className="font-mono opacity-70">{subject.isLecture ? "P" : "C"}</span>
                                                    </div>
                                                    <div className="pl-1.5 font-semibold truncate" title={subject.teacher}>{subject.teacher}</div>
                                                    <div></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            );
                        })}
                        </div>
                    </div>
                    {tooltip && (
                        <>
                            <div onClick={() => setTooltip(null)} style={{
                                position: 'fixed',
                                inset: 0,
                                zIndex: 95,
                                backgroundColor: '#00000022',
                                cursor: 'default',
                                touchAction: 'none'
                            }} />
                            <div style={{
                                position: 'fixed',
                                top: tooltip.y + 15, // Trochu posuneme pod kurzor
                                left: tooltip.isTouch ? tooltip.x : tooltip.x + 15,
                                transform: tooltip.isTouch ? 'translateX(-50%)' : 'none',
                                backgroundColor: '#1f2937', // Tmavƒõ ≈°ed√° (lad√≠ s designem)
                                border: '1px solid #4b5563',
                                padding: '12px',
                                borderRadius: '8px',
                                zIndex: 100, // Aby bylo nad v≈°√≠m ostatn√≠m
                                boxShadow: '0 4px 6px rgba(0,0,0,0.5)',
                                color: 'white',
                                maxWidth: '300px',
                                pointerEvents: 'auto', // Aby ≈°lo kliknout na zav√≠rac√≠ k≈ô√≠≈æek
                                touchAction: 'none'
                            }}>
                            <div className="font-bold text-xs text-gray-400 mb-1 uppercase tracking-wider">Vyuƒçuj√≠c√≠</div>
                            <div className="text-sm font-medium">{tooltip.teacher}</div>
                            
                            <div className="font-bold text-xs text-gray-400 mt-3 mb-1 uppercase tracking-wider">M√≠stnost</div>
                            <div className="text-sm font-medium">
                                {tooltip.roomUrl ? (
                                    <a href={tooltip.roomUrl} target="_blank" rel="noreferrer" className="text-sky-400 hover:text-sky-300 underline decoration-sky-400/50 hover:decoration-sky-300">
                                        {tooltip.room} <i className="fas fa-external-link-alt text-[10px] ml-1 opacity-70"></i>
                                    </a>
                                ) : tooltip.room}
                            </div>


                            {/* Tlaƒç√≠tko pro zav≈ôen√≠ */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation(); // Aby se neprokliklo nic pod t√≠m
                                    setTooltip(null);
                                }}
                                className="absolute -top-2 -right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md transition-colors"
                            >
                                <i className="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        </>
                    )}


                    <span class="text-xs text-gray-400">forked and vibe coded by <a class="underline" href="https://instagram.com/kuba.799">JJZ</a><br>4.2.2026 9am üåÑ - 5.2.2026 4am ‚òïÔ∏è</span>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>

</html>
