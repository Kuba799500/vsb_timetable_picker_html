<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V≈†B Timetable Picker HTML</title>

    <link rel="icon" type="image/svg+xml" href="/vsb_timetable_picker_html/icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous">
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>

    <style>
        body {
            background-color: #242424;
            color: rgba(255, 255, 255, 0.87);
            font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
            overflow-y: scroll;
        }

        #root {
            max-width: 80rem;
            margin: 0 auto;
            padding-top: 2rem;
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }

        ::-webkit-scrollbar-track {
            background: #333;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 0.25rem;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(0.25rem);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes modalOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        .shake {
            animation: shake 0.2s ease-in-out 0s 2;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        window.name = "vsb_timetable_picker_win";
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- DEMO DATA ---
        const DEMO_DATA = [
            {
                title: "info",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "Pondƒõl√≠",
                                queues: [
                                    { items: [{ used: true, duration: 4, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:30", teacherShortNamesString: "Kliknƒõte sem prav√Ωm tlaƒç√≠tkem...", teacherFullNamesString: "V√Ωbornƒõ! Zde se v√°m zobraz√≠ cel√° jm√©na vyuƒçuj√≠c√≠ch. Prozkoumejte dal≈°√≠ pol√≠ƒçka s ikonou ‚ìò a seznamte se s Timetablem :)", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 101, roomFullCodesString: "" } }] },
                                    { items: [{ used: true, duration: 4, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:30", teacherShortNamesString: "...nebo podr≈æte prstem", teacherFullNamesString: "V√Ωbornƒõ! Zde se v√°m zobraz√≠ cel√° jm√©na vyuƒçuj√≠c√≠ch. Prozkoumejte dal≈°√≠ pol√≠ƒçka s ikonou ‚ìò a seznamte se s Timetablem :)", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 102, roomFullCodesString: "" } }] }
                                ]
                            },
                            {
                                title: "√öter√Ω",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "16:00", scheduleWindowEndTime: "18:30", teacherShortNamesString: "Export rozvrhu ‚ìò", teacherFullNamesString: "Pokud chcete sd√≠let v√°≈° rozvrh s kamar√°dy nebo si ulo≈æit jednu z variant, vyu≈æijte tuto mo≈ænost v menu \"Spr√°va rozvrhu\".", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 302 } }] }
                                ]
                            },
                            {
                                title: "ƒåtvrtek",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "ƒåerven√° ƒç√°ra ‚ìò", teacherFullNamesString: "To je jenom ukazatel aktu√°ln√≠ho ƒçasu xdd", subjectAbbrev: "INFO", lecture: true, concreteActivityId: 103, roomFullCodesString: "" } }] }
                                ]
                            },
                            {
                                title: "P√°tek",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "07:15", scheduleWindowEndTime: "09:45", teacherShortNamesString: "M√≠stnosti ‚ìò", teacherFullNamesString: "Kliknut√≠m na odkaz n√≠≈æe zobraz√≠te mapu s lokac√≠ m√≠stnosti:", subjectAbbrev: "INFO", lecture: false, concreteActivityId: 104, roomFullCodesString: "PORUA1" } }] }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "kolize",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "√öter√Ω",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "Zvolen√≠ hodiny ‚ìò", teacherFullNamesString: "Kliknut√≠m lev√Ωm tlaƒç√≠tkem nebo ≈•uknut√≠m zvol√≠te hodinu p≈ôedmƒõtu. Z√°rove≈à se skryj√≠ ostatn√≠ hodiny tohoto p≈ôedmƒõtu a hodiny kter√© zaƒç√≠naj√≠ ve stejn√Ω ƒças. (Jak je zobrazit se dozv√≠te v pol√≠ƒçku n√≠≈æe)", subjectAbbrev: "KOLIZE", lecture: false, concreteActivityId: 201, roomFullCodesString: "" } }] },
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "11:30", scheduleWindowEndTime: "12:15", teacherShortNamesString: "Zobraz. skryt√Ωch ‚ìò", teacherFullNamesString: "Pro odkryt√≠ kliknƒõte na p≈ôep√≠naƒç pod nadpisem str√°nky. Zobraz√≠ se v√°m v≈°echny hodiny, kter√© koliduj√≠ se zvolenou hodinou, nebo ostatn√≠ hodiny z vybran√©ho p≈ôedmƒõtu.", subjectAbbrev: "KOLIZE", lecture: false, concreteActivityId: 202, roomFullCodesString: "" } }] }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "Smazat",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "Pondƒõl√≠",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "14:15", scheduleWindowEndTime: "19:15", teacherShortNamesString: "Reset ‚ìò", teacherFullNamesString: "Pokud byste chtƒõli znovu zobrazit DEMO nebo smazat v≈°echny nahran√© p≈ôedmƒõty, m≈Ø≈æete vyu≈æ√≠t tlaƒç√≠tko \"Smazat v≈°e a resetovat\" v menu Spr√°va rozvrhu.", subjectAbbrev: "SMAZAT", lecture: true, concreteActivityId: 302, roomFullCodesString: "" } }] }
                                ]
                            },
                            {
                                title: "P√°tek",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "16:45", scheduleWindowEndTime: "19:15", teacherShortNamesString: "Smazat p≈ôedmƒõt ‚ìò", teacherFullNamesString: "P≈ôi najet√≠ na p≈ôedmƒõt v nab√≠dce naho≈ôe se v√°m uk√°≈æe k≈ô√≠≈æek. T√≠m m≈Ø≈æete p≈ôedmƒõt smazat (nebojte, m≈Ø≈æete ho pak znovu nahr√°t)", subjectAbbrev: "SMAZAT", lecture: true, concreteActivityId: 301, roomFullCodesString: "" } }] }
                                ]
                            }
                        ]
                    }
                }
            },
            {
                title: "demo1",
                data: {
                    subjectScheduleTable: {
                        days: [
                            {
                                title: "√öter√Ω",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "16:45", scheduleWindowEndTime: "17:30", teacherShortNamesString: "Zobraz. p≈ôedmƒõt≈Ø ‚ìò", teacherFullNamesString: "P≈ôi kliknut√≠ na p≈ôedmƒõt v horn√≠ nab√≠dce zobraz√≠te v≈°echny jeho hodiny. Zvolen√© hodiny z jin√Ωch p≈ôedmƒõt≈Ø se v√°m zde tak√© objev√≠.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 302, roomFullCodesString: "" } }] }
                                ]
                            },
                            {
                                title: "St≈ôeda",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "08:00", scheduleWindowEndTime: "10:30", teacherShortNamesString: "P≈ôedn√°≈°ka ‚ìò", teacherFullNamesString: "P≈ôedn√°≈°kov√° hodina je oznaƒçena p√≠smenem \"P\" vpravo naho≈ôe a m√° ƒçervenou barvu.", subjectAbbrev: "DEMO1", lecture: true, concreteActivityId: 303, roomFullCodesString: "" } }] },
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "09:00", scheduleWindowEndTime: "11:30", teacherShortNamesString: "Cviƒçen√≠ ‚ìò", teacherFullNamesString: "Hodina cviƒçen√≠ je oznaƒçena p√≠smenem \"C\" vpravo naho≈ôe a m√° modrou barvu.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 304, roomFullCodesString: "" } }] },
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "12:30", scheduleWindowEndTime: "14:15", teacherShortNamesString: "Povinnosti ‚ìò", teacherFullNamesString: "U p≈ôedmƒõtu v horn√≠ nab√≠dce se zobraz√≠ zda si m√°te zvolit p≈ôedn√°≈°ku a/nebo cviƒçen√≠. P≈ôi zvolen√≠ se ikona probarv√≠. (Standartnƒõ 1 p≈ôedn√°≈°ka a/nebo cviƒçen√≠. Jinak bych musel k√≥d dost upravit üíÄ)", subjectAbbrev: "DEMO1", lecture: true, concreteActivityId: 305, roomFullCodesString: "" } }] },
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "14:15", scheduleWindowEndTime: "15:45", teacherShortNamesString: "Spr√°va rozvrhu ‚ìò", teacherFullNamesString: "Kliknut√≠m na tlaƒç√≠tko pod nadpisem str√°nky se dostanete do menu, kde m≈Ø≈æete nahr√°vat sv√© p≈ôedmƒõty (je zde i odkaz na n√°povƒõdu). Va≈°e soubory automaticky p≈ôep√≠≈°ou DEMO, tak≈æe nemus√≠te nic mazat. Pokud nahrajete p≈ôedmƒõt, kter√Ω se zde ji≈æ nach√°z√≠, tak se pou≈æij√≠ data z novƒõ nahran√©ho.", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 306 } }] }
                                ]
                            },
                            {
                                title: "P√°tek",
                                queues: [
                                    { items: [{ used: true, duration: 3, dto: { scheduleWindowBeginTime: "12:30", scheduleWindowEndTime: "15:00", teacherShortNamesString: "Kapacita ‚ìò", teacherFullNamesString: "Mezi zkratkou p≈ôedmƒõtu a typem hodiny (P/C) se zobraz√≠ kapacita uƒçebny dan√© hodiny. Tyto data se ƒçasto mƒõn√≠, zkontrolujte v Edisonu. Pokud bude kapacita 0, nebo bude je≈°tƒõ p≈ôed volbou rozvrhu hodina zaplnƒõna, nem≈Ø≈æete se ji≈æ p≈ôihl√°sit!", subjectAbbrev: "DEMO1", lecture: false, concreteActivityId: 302, concreteActivityCapacity: 123 } }] }
                                ]
                            }
                        ]
                    }
                }
            }
        ];

        const Modal = ({ isOpen, onClose, children, title }) => {
            const shouldRender = useMountTransition(isOpen, 100);
            useBodyScrollLock(shouldRender);

            if (!shouldRender) return null;

            const overlayStyle = { animation: isOpen ? 'fadeIn 0.2s ease-out forwards' : 'fadeOut 0.1s ease-out forwards' };
            const modalStyle = { animation: isOpen ? 'modalIn 0.2s ease-out forwards' : 'modalOut 0.1s ease-in forwards' };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4" onClick={onClose} style={overlayStyle}>
                    <div className="bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()} style={modalStyle}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                            <i className="fas fa-times text-xl"></i>
                        </button>
                        <h2 className="text-2xl font-bold mb-3 text-white">{title}</h2>
                        {children}
                    </div>
                </div>
            );
        };



        const Notification = ({ message, type, onClose }) => {
            const [isClosing, setIsClosing] = useState(false);

            const closeWithAnimation = () => {
                setIsClosing(true);
                setTimeout(onClose, 200);
            };

            useEffect(() => {
                if (type === 'success' || type === 'error') {
                    const timer = setTimeout(closeWithAnimation, 5000);
                    return () => clearTimeout(timer);
                }
            }, [type, onClose]);

            const overlayStyle = { animation: isClosing ? 'fadeOut 0.2s ease-out forwards' : 'fadeIn 0.2s ease-out forwards' };
            const modalStyle = { animation: isClosing ? 'modalOut 0.2s ease-in forwards' : 'modalIn 0.2s ease-out forwards' };

            return ReactDOM.createPortal(
                <div className="fixed inset-0 z-[110] flex items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" style={overlayStyle}></div>
                    <div className="bg-gray-800 border border-gray-600 shadow-2xl rounded-lg p-6 flex flex-col items-center gap-4 pointer-events-auto relative min-w-[250px]" style={modalStyle}>
                        {type === 'loading' && <i className="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>}
                        {type === 'success' && <i className="fas fa-check-circle text-4xl text-green-500"></i>}
                        {type === 'error' && <i className="fas fa-exclamation-circle text-4xl text-red-500"></i>}
                        <div className="text-white font-medium text-lg text-center whitespace-pre-line">{message}</div>
                        {type !== 'loading' && (
                            <button onClick={closeWithAnimation} className="mt-2 bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-full transition-colors font-semibold text-sm">Zav≈ô√≠t</button>
                        )}
                    </div>
                </div>,
                document.body
            );
        };

        const bookmarkletCode = `javascript:(async()=>{const u="https://kuba799500.github.io/vsb_timetable_picker_html",t="https://edison.sso.vsb.cz/wps/myportal/student/rozvrh/volba-rozvrhu",ff=navigator.userAgent.includes("Firefox");if(!location.href.startsWith(t))return window.open(t,"_blank");let d=document,b=d.body,n=d.createElement("div");n.style.cssText="position:fixed;top:20px;right:20px;background:red;color:white;padding:15px;z-index:9999;font-size:20px;border-radius:5px;";n.textContent="Stahov√°n√≠ dat...";b.appendChild(n);const o=[...d.querySelectorAll("a")].map(e=>{let c=e.getAttribute("onclick")||"",m=c.match(/(\\w+)_selectStudyYearObligation\\s*\\(\\s*(\\d+)/),id=m?m[2]:(e.href.match(/EselectStudyYearObligationId!(\\d+)/)||[])[1],pid=m?m[1]:null;return id?{id,pid:pid&&!pid.endsWith("_")?pid+"_":pid}:null}).filter(Boolean);if(!o.length){n.textContent="Nebyly nalezeny ≈æ√°dn√© p≈ôedmƒõty.";return setTimeout(()=>n.remove(),3e3)}let w=null;if(!ff){w=window.open("","vsb_timetable_picker_win");try{if(w.location.href==="about:blank")w.location.href=u;w.postMessage({type:"VSB_DOWNLOAD_STARTED",count:o.length},"*")}catch(e){}}const s={};for(const{id,pid}of o){n.textContent=\`Stahov√°n√≠ dat... (\${Object.keys(s).length+1}/\${o.length})\`;try{let r=await fetch(\`/wps/.cz.vsb.edison.edu.study.pass.portlet/jaxrs/scheduleSelection/selectStudyYearObligation/\${id}\`,{method:"PUT",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest","Accept":"application/json"},body:new URLSearchParams({portletId:pid||""})});s[id]=r.ok?await r.json():{error:"http",status:r.status}}catch(e){s[id]={error:"fetch",message:String(e)}}}let sent=false;if(!ff&&w&&!w.closed){n.textContent="ƒåek√°m na aplikaci...";let ack=false;const onAck=(e)=>{if(e.data&&e.data.type==="VSB_READY")ack=true};window.addEventListener("message",onAck);for(let i=0;i<20&&!ack;i++){try{w.postMessage({type:"VSB_SCHEDULE_DATA",payload:s},"*")}catch(e){}await new Promise(r=>setTimeout(r,500))}window.removeEventListener("message",onAck);if(ack){window.close();n.remove();sent=true;w.focus()}}if(!sent){n.remove();let k=Object.keys(s);if(k.length&&confirm(\`Nezda≈ôilo se p≈ôesmƒõrov√°n√≠ zpƒõt na Timetable.\\nSoubory nahrajte ruƒçnƒõ p≈ôes nab√≠dku "Spr√°va rozvrhu" -> "Vybrat soubory".\\n\\nChcete st√°hnout \${k.length} soubor≈Ø?\`)){for(let i of k){let d=s[i],sub=d?.subjectScheduleTable?.days?.flatMap(x=>x.queues||[])?.flatMap(x=>x.items||[])?.find(x=>x.dto?.subjectAbbrev)?.dto?.subjectAbbrev,a=document.createElement("a");a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:"application/json"}));a.download=sub?\`\${i}-\${sub}.json\`:\`subject_\${i}.json\`;document.body.appendChild(a);a.click();a.remove();await new Promise(r=>setTimeout(r,500))}}}})();`;

        const timeSlots = [
            "07:15-08:00", "08:00-08:45", "09:00-09:45", "09:45-10:30", "10:45-11:30",
            "11:30-12:15", "12:30-13:15", "13:15-14:00", "14:15-15:00", "15:00-15:45",
            "16:00-16:45", "16:45-17:30", "17:45-18:30", "18:30-19:15",
        ];

        const colors = ["bg-green-700", "bg-fuchsia-500", "bg-orange-500", "bg-yellow-500", "bg-purple-700", "bg-pink-900", "bg-indigo-500", "bg-violet-900"];

        const SLOT_MIN = 50;
        const SLOT_MAX = 75;

        const calculateSlotWidth = (viewportWidth) => {
            const NUM_SLOTS = timeSlots.length + 1
            const idealSlotWidth = (viewportWidth - 8) / NUM_SLOTS;
            return Math.max(SLOT_MIN, Math.min(SLOT_MAX, idealSlotWidth));
        };

        const calculateCurrentTimePosition = (slotWidth) => {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const TIME_SLOT_WIDTH = slotWidth;

            for (let i = 0; i < timeSlots.length; i++) {
                const [start, end] = timeSlots[i].split("-").map((t) => {
                    const [h, m] = t.split(":").map(Number);
                    return h * 60 + m;
                });

                if (currentMinutes < start) {
                    if (i === 0) {
                        return 1;
                    }
                    return i * TIME_SLOT_WIDTH;
                }

                if (currentMinutes >= start && currentMinutes < end) {
                    const slotProgress = (currentMinutes - start) / (end - start);
                    const position = i * TIME_SLOT_WIDTH + slotProgress * TIME_SLOT_WIDTH;
                    return position === 0 ? 1 : position;
                }

            }

            return timeSlots.length * TIME_SLOT_WIDTH;
        };

        const calculateEndTime = (startTime, duration) => {
            startTime = startTime.substring(0, 5);
            const startIndex = timeSlots.findIndex(slot => slot.startsWith(startTime));

            if (startIndex === -1) return "??:??";
            const endIndex = startIndex + duration - 1;

            if (endIndex < timeSlots.length) {
                return timeSlots[endIndex].split("-")[1];
            }

            return "??:??";
        };

        const formatSchedule = (scheduleTable) => {
            const formatted = [];
            if (!scheduleTable || !scheduleTable.days) return [];
            scheduleTable.days.forEach((day) => {
                day.queues.forEach((queue) => {
                    queue.items.forEach((item) => {
                        if (item.used && item.dto) {
                            const duration = item.duration || 2;
                            formatted.push({
                                day: day.title,
                                startTime: item.dto.scheduleWindowBeginTime,
                                endTime: calculateEndTime(item.dto.scheduleWindowBeginTime, duration),
                                teacher: item.dto.teacherShortNamesString,
                                teacherFull: item.dto.teacherFullNamesString,
                                abbreviation: item.dto.subjectAbbrev,
                                isLecture: item.dto.lecture,
                                duration: duration,
                                activityId: item.dto.concreteActivityId,
                                roomId: item.dto.roomFullCodesString,
                                capacity: item.dto.concreteActivityCapacity,
                            });
                        }
                    });
                });
            });
            return formatted;
        };

        // Tetris Layout Logic
        const calculateLayout = (entries) => {
            const sorted = [...entries].sort((a, b) => {
                if (a.startTime !== b.startTime) return a.startTime.localeCompare(b.startTime);
                return b.duration - a.duration;
            });

            const rows = [];

            const positioned = sorted.map(entry => {
                let rowIndex = -1;
                for (let r = 0; r < rows.length; r++) {
                    if (entry.startTime >= rows[r]) {
                        rowIndex = r;
                        rows[r] = entry.endTime;
                        break;
                    }
                }
                if (rowIndex === -1) {
                    rowIndex = rows.length;
                    rows.push(entry.endTime);
                }
                return { ...entry, visualRowIndex: rowIndex };
            });

            return {
                items: positioned,
                rowCount: Math.max(1, rows.length)
            };
        };

        const getTimeSlotIndex = (time) => {
            return timeSlots.findIndex(slot => slot.startsWith(time)) + 2;
        }

        const useLocalStorage = (key, initialValue, customParse = x => x, customFormat = x => x) => {
            const [storedValue, setStoredValue] = useState(() => {
                if (typeof window === "undefined") {
                    return initialValue;
                }
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? customParse(JSON.parse(item)) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    if (typeof window !== "undefined") {
                        window.localStorage.setItem(key, JSON.stringify(customFormat(valueToStore)));
                    }
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        };

        const useLongPress = ({ onLongPress, delay = 500 }) => {
            const timerRef = useRef(null);
            const isLongPress = useRef(false);
            const startPos = useRef({ x: 0, y: 0 });

            const handleTouchStart = (e, context) => {
                isLongPress.current = false;
                const touch = e.touches[0];
                const x = touch.clientX;
                const y = touch.clientY;
                startPos.current = { x, y };

                timerRef.current = setTimeout(() => {
                    isLongPress.current = true;
                    if (onLongPress) onLongPress(e, context, { x, y });
                }, delay);
            };

            const handleTouchMove = (e) => {
                if (timerRef.current) {
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - startPos.current.x);
                    const moveY = Math.abs(touch.clientY - startPos.current.y);
                    if (moveX > 10 || moveY > 10) {
                        clearTimeout(timerRef.current);
                        timerRef.current = null;
                    }
                }
            };

            const handleTouchEnd = (e) => {
                if (timerRef.current) {
                    clearTimeout(timerRef.current);
                    timerRef.current = null;
                }
                if (isLongPress.current) {
                    if (e.cancelable) e.preventDefault();
                    // Prevent click immediately after long press
                    setTimeout(() => { isLongPress.current = false; }, 200);
                }
            };

            return {
                handlers: {
                    onTouchStart: handleTouchStart,
                    onTouchMove: handleTouchMove,
                    onTouchEnd: handleTouchEnd
                },
                isLongPress
            };
        };

        // Helper: Najde prvn√≠ subjectAbbrev v JSON datech
        const findSubjectAbbrev = (json) => {
            const items = (json.subjectScheduleTable?.days || []).flatMap(d => (d.queues || []).flatMap(q => q.items || []));
            return items.find(it => it.dto?.subjectAbbrev)?.dto.subjectAbbrev;
        };

        // Helper: P≈ôeƒçte soubor jako JSON
        const readFileAsJSON = (file) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    resolve({ title: file.name.replace(".json", ""), data: json.default || json });
                } catch { resolve(null); }
            };
            reader.readAsText(file);
        });

        const useMountTransition = (isMounted, unmountDelay) => {
            const [hasTransitionedIn, setHasTransitionedIn] = useState(false);

            useEffect(() => {
                let timeoutId;
                if (isMounted && !hasTransitionedIn) {
                    setHasTransitionedIn(true);
                } else if (!isMounted && hasTransitionedIn) {
                    timeoutId = setTimeout(() => setHasTransitionedIn(false), unmountDelay);
                }
                return () => clearTimeout(timeoutId);
            }, [unmountDelay, isMounted, hasTransitionedIn]);

            return hasTransitionedIn;
        };

        const useBodyScrollLock = (isLocked) => {
            useLayoutEffect(() => {
                if (!isLocked) return;

                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                const scrollY = window.scrollY;
                const originalStyles = {
                    position: document.body.style.position,
                    top: document.body.style.top,
                    width: document.body.style.width,
                    overflow: document.body.style.overflow,
                    paddingRight: document.body.style.paddingRight,
                    boxSizing: document.body.style.boxSizing
                };

                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollY}px`;
                document.body.style.width = '100vw'; // Use 100vw to cover viewport
                document.body.style.overflow = 'hidden';
                document.body.style.boxSizing = 'border-box'; // Ensure padding is inside
                // Only add padding if there was a scrollbar
                if (scrollbarWidth > 0) {
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                }

                return () => {
                    document.body.style.position = originalStyles.position;
                    document.body.style.top = originalStyles.top;
                    document.body.style.width = originalStyles.width;
                    document.body.style.overflow = originalStyles.overflow;
                    document.body.style.paddingRight = originalStyles.paddingRight;
                    document.body.style.boxSizing = originalStyles.boxSizing;
                    window.scrollTo(0, scrollY);
                };
            }, [isLocked]);
        };

        const App = () => {
            const [timetableData, setTimetableData] = useLocalStorage("vsb_timetable_data", DEMO_DATA, (parsed) => {
                return parsed && parsed.length > 0 ? parsed : DEMO_DATA;
            });

            const [selectedEntries, setSelectedEntries] = useLocalStorage("selectedEntries", new Set(),
                (arr) => new Set(arr),
                (set) => Array.from(set)
            );

            const [selectedSubjects, setSelectedSubjects] = useLocalStorage("selectedSubjects", new Set(),
                (arr) => new Set(arr),
                (set) => Array.from(set)
            );

            const [showUnusedClasses, setShowUnusedClasses] = useLocalStorage("showUnusedClasses", false);

            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);

            const [tooltip, setTooltip] = useState(null);
            const [isClosing, setIsClosing] = useState(false);
            const [notification, setNotification] = useState(null);
            const [copyStatus, setCopyStatus] = useState(null);

            const [isTouchDevice, setIsTouchDevice] = useState(false);
            useEffect(() => {
                setIsTouchDevice('ontouchstart' in window || navigator.maxTouchPoints > 0);
            }, []);

            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportedBlob, setExportedBlob] = useState(null);
            const [exportedFileName, setExportedFileName] = useState("");



            useEffect(() => {
                const handleMessage = (event) => {
                    if (event.origin !== "https://edison.sso.vsb.cz") return;

                    if (event.data && event.data.type === 'VSB_SCHEDULE_DATA') {
                        const results = event.data.payload;
                        processImportedData(results);
                        try { event.source.postMessage({ type: "VSB_READY" }, event.origin); } catch (e) { }
                    }

                    if (event.data && event.data.type === 'VSB_DOWNLOAD_STARTED') {
                        setNotification({
                            message: `Stahov√°n√≠ ${event.data.count} p≈ôedmƒõt≈Ø z Edisonu...`,
                            type: "loading"
                        });
                    }
                };
                window.addEventListener("message", handleMessage);

                return () => window.removeEventListener("message", handleMessage);
            }, []);

            const copyToClipboard = () => {
                navigator.clipboard.writeText(bookmarkletCode).then(() => {
                    setCopyStatus('success');
                    setTimeout(() => setCopyStatus(null), 3000);
                }).catch(err => {
                    console.error(err);
                    setCopyStatus('error');
                    setTimeout(() => setCopyStatus(null), 3000);
                });
            };

            const closeTooltip = (e) => {
                if (e) e.stopPropagation();
                setIsClosing(true);
                setTimeout(() => {
                    setTooltip(null);
                    setIsClosing(false);
                }, 100);
            };

            // Reset stavu zav√≠r√°n√≠ p≈ôi otev≈ôen√≠ nov√©ho tooltipu
            useEffect(() => {
                if (tooltip) setIsClosing(false);
            }, [tooltip]);



            useLayoutEffect(() => {
                if (tooltip) {
                    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                    document.body.style.overflow = 'hidden';
                    document.documentElement.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.documentElement.style.overflow = '';
                }
                return () => {
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.documentElement.style.overflow = '';
                };
            }, [tooltip]);

            useEffect(() => {
                if (tooltip && tooltip.room && !tooltip.roomUrl) {
                    const controller = new AbortController();
                    const fetchRoom = async () => {
                        try {
                            // Pou≈æijeme CORS proxy, proto≈æe API mapy.vsb.cz neumo≈æ≈àuje p≈ô√≠m√© vol√°n√≠ z prohl√≠≈æeƒçe (CORS error)
                            const targetUrl = `https://mapy.vsb.cz/maps/api/v0/rooms/autocomplete?query=${encodeURIComponent(tooltip.room)}&language=cs`;
                            const res = await fetch(`https://cors.eu.org/${targetUrl}`, { signal: controller.signal });
                            if (res.ok) {
                                const data = await res.json();
                                if (Array.isArray(data) && data.length > 0) {
                                    const id = data[0].id;
                                    const url = `https://mapy.vsb.cz/maps/?id=${id}&type=rooms&lang=cs`;
                                    console.log(`Fetched room URL for ${tooltip.room}: ${url}`);
                                    setTooltip(prev => (prev && prev.room === tooltip.room ? { ...prev, roomUrl: url } : prev));
                                }
                            }
                        } catch (e) { }
                    };
                    fetchRoom();
                    return () => controller.abort();
                }
            }, [tooltip]);


            const subjectColors = useRef({}).current;




            const [slotWidth, setSlotWidth] = useState(() => {
                const w = typeof window !== 'undefined' ? window.innerWidth : 1024;
                return calculateSlotWidth(w);
            });

            useEffect(() => {
                const onResize = () => {
                    setSlotWidth(calculateSlotWidth(window.innerWidth));
                };
                window.addEventListener('resize', onResize);
                return () => window.removeEventListener('resize', onResize);
            }, []);



            const [currentTimePosition, setCurrentTimePosition] = useState(calculateCurrentTimePosition(slotWidth));

            // Update position immediately when slot width changes (responsive resize)
            useEffect(() => {
                setCurrentTimePosition(calculateCurrentTimePosition(slotWidth));
            }, [slotWidth]);

            // Update position every 60 seconds for time passage
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTimePosition(calculateCurrentTimePosition(slotWidth));
                }, 60000);
                return () => clearInterval(interval);
            }, []);

            // localStorage sync for selectedEntries and selectedSubjects is handled by useLocalStorage hook

            const getFileName = () => {
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                return `rozvrh_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}.png`;
            };

            const handleExportJpg = () => {
                const element = document.getElementById('timetable-content');
                if (!element) return;
                setNotification({ message: "Generov√°n√≠ obr√°zku...", type: "loading" });
                setTimeout(() => {
                    window.htmlToImage.toBlob(element, {
                        quality: 0.95,
                        pixelRatio: 3,
                        backgroundColor: '#242424',
                        type: 'image/jpeg',
                        filter: (node) => !node.classList || !node.classList.contains('no-export')
                    }).then(blob => {
                        const fileName = getFileName();
                        setExportedBlob(blob);
                        setExportedFileName(fileName);
                        setExportModalOpen(true);
                        setNotification(null);
                        setTimeout(() => shareImage(blob, fileName), 500);
                    }).catch(err => {
                        console.error(err);
                        setNotification({ message: "Chyba p≈ôi exportu.", type: "error" });
                    });
                }, 100);
            };

            const downloadImage = () => {
                if (!exportedBlob) return;
                const link = document.createElement('a');
                link.download = exportedFileName || 'rozvrh.png';
                link.href = URL.createObjectURL(exportedBlob);
                link.click();
                URL.revokeObjectURL(link.href);
                setNotification({ message: "Obr√°zek sta≈æen.", type: "success" });
                setExportModalOpen(false);
            };

            const shareImage = async (directBlob = null, directName = null) => {
                const blobToShare = (directBlob instanceof Blob) ? directBlob : exportedBlob;
                const nameToShare = (typeof directName === 'string' ? directName : exportedFileName) || 'rozvrh.png';
                if (!blobToShare) return;
                const file = new File([blobToShare], nameToShare, { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'M≈Øj rozvrh',
                            text: 'Pod√≠vej se na m≈Øj rozvrh!'
                        });
                        setExportModalOpen(false);
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error(err);
                            setNotification({ message: "Chyba p≈ôi sd√≠len√≠.", type: "error" });
                        }
                    }
                } else {
                    setNotification({ message: "Va≈°e za≈ô√≠zen√≠ nepodporuje sd√≠len√≠.", type: "error" });
                }
            };

            // Helper: Slouƒç√≠ nov√° data s existuj√≠c√≠mi (nahrad√≠ DEMO, jinak p≈ôid√° nov√©)
            const mergeTimetableData = (newData) => {
                setTimetableData(prev => {
                    const isDEMO = prev.length === DEMO_DATA.length && prev.every((item, idx) => item.title === DEMO_DATA[idx].title);
                    if (isDEMO) return newData;
                    const existingTitles = new Set(prev.map(p => p.title));
                    return [...prev, ...newData.filter(d => !existingTitles.has(d.title))];
                });
            };

            const processImportedData = (results) => {
                setNotification({ message: "Zpracov√°v√°n√≠ dat...", type: "loading" });

                const parsedData = Object.entries(results)
                    .filter(([, json]) => !json.error)
                    .map(([id, json]) => ({ title: findSubjectAbbrev(json) || id, data: json }));

                if (parsedData.length > 0) {
                    mergeTimetableData(parsedData);
                    setIsUploadModalOpen(false);
                    setNotification({ message: `√öspƒõ≈°nƒõ nahr√°no ${parsedData.length} p≈ôedmƒõt≈Ø.`, type: "success" });
                } else {
                    setNotification({ message: "Nepoda≈ôilo se naƒç√≠st ≈æ√°dn√° data.", type: "error" });
                }
            };

            // Handlery
            const handleFileUpload = (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                Promise.all(files.map(readFileAsJSON)).then(results => {
                    const validData = results.filter(Boolean);
                    if (validData.length > 0) {
                        mergeTimetableData(validData);
                        setIsUploadModalOpen(false);
                    }
                });
            };

            // Two-step delete all: perform deletion without browser confirm
            const performDeleteAll = () => {
                // Pokud jsou aktu√°ln√≠ data pr√°zdn√°, naƒçteme DEMO. Jinak je vyma≈æeme.
                if (timetableData.length === 0) {
                    setTimetableData(DEMO_DATA);
                } else {
                    setTimetableData([]);
                }
                setSelectedEntries(new Set());
                setSelectedSubjects(new Set());
                setIsUploadModalOpen(false);
                setConfirmDeleteAll(false);
                setShowUnusedClasses(false);
            };

            const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);



            // Two-step delete: perform deletion without browser confirm
            const performDeleteSubject = (subjectName) => {
                setTimetableData(prev => prev.filter(fileItem => {
                    const containsSubject = fileItem.title.includes(subjectName) ||
                        (fileItem.data?.subjectScheduleTable?.days || []).some(d =>
                            d.queues.some(q => q.items.some(it => it.dto?.subjectAbbrev === subjectName))
                        );
                    return !containsSubject;
                }));
                setSelectedSubjects(prev => {
                    const newSet = new Set(prev);
                    newSet.delete(subjectName);
                    return newSet;
                });
                // clear any pending confirm state
                setConfirmDeleteSubject(null);
            }

            const [confirmDeleteSubject, setConfirmDeleteSubject] = useState(null);

            // --- LONG PRESS LOGIC via Hook ---
            const { handlers: touchHandlers, isLongPress } = useLongPress({
                onLongPress: (e, subject, { x, y }) => {
                    setTooltip({
                        x,
                        y,
                        teacher: subject.teacherFull,
                        room: subject.roomId,
                        isTouch: true
                    });
                }
            });
            const tooltipRef = useRef(null);

            // V√Ωpoƒçet pozice tooltipu podle jeho skuteƒçn√© v√Ω≈°ky
            useLayoutEffect(() => {
                if (tooltip && tooltipRef.current) {
                    const updatePosition = () => {
                        const el = tooltipRef.current;
                        if (!el) return;

                        const height = el.offsetHeight;
                        const gap = 15; // Mezera od kurzoru

                        if (tooltip.y + height + gap > window.innerHeight) {
                            el.style.top = `${window.innerHeight - height - 10}px`;
                        } else {
                            el.style.top = `${tooltip.y + gap}px`;
                        }
                    };

                    updatePosition();
                    // iOS fix: P≈ôepoƒç√≠tat je≈°tƒõ jednou v dal≈°√≠m frame, kdyby se v√Ω≈°ka zmƒõnila po vykreslen√≠
                    const rafId = requestAnimationFrame(updatePosition);
                    return () => cancelAnimationFrame(rafId);
                }
            }, [tooltip]);







            const allEntries = timetableData.map(({ data }) => formatSchedule(data.subjectScheduleTable)).flat();

            let pomI = 0;
            allEntries.forEach((entry) => {
                if (!subjectColors[entry.abbreviation]) {
                    subjectColors[entry.abbreviation] = colors[pomI % colors.length];
                    pomI++;
                }
            });



            const pickClass = (entry) => {
                setSelectedEntries((prev) => {
                    const newSet = new Set(prev);
                    const key = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                    if (newSet.has(key)) newSet.delete(key);
                    else newSet.add(key);
                    return newSet;
                });
            };

            const toggleSubject = (subject) => {
                setSelectedSubjects((prev) => {
                    const newSet = new Set(prev);
                    if (newSet.has(subject)) newSet.delete(subject);
                    else newSet.add(subject);
                    return newSet;
                });
            };

            const groupAndFilterEntries = () => {
                const grouped = { Pondƒõl√≠: [], √öter√Ω: [], St≈ôeda: [], ƒåtvrtek: [], P√°tek: [] };

                allEntries.forEach((entry) => {
                    const key = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                    const isSelected = selectedEntries.has(key);
                    const isSubjectVisible = selectedSubjects.size === 0 || selectedSubjects.has(entry.abbreviation);
                    const isCollisionVisible = showUnusedClasses || !isEntryHidden(entry);

                    if (isSubjectVisible && (isCollisionVisible || isSelected)) {
                        if (grouped[entry.day]) grouped[entry.day].push(entry);
                    }
                });
                return grouped;
            }

            const uniqueSubjects = [...new Set(allEntries.map((entry) => `${entry.abbreviation}~${entry.isLecture ? "P" : "C"}`))];
            const subjectTypesMap = uniqueSubjects.reduce((acc, subject) => {
                const [name, type] = subject.split("~");
                if (!acc[name]) acc[name] = [];
                acc[name].push(type);
                return acc;
            }, {});

            // Pre-computed lookup map: key -> entry (O(1) instead of O(n) find)
            const entryByKey = new Map();
            allEntries.forEach(e => {
                const k = `${e.day}~${e.startTime}~${e.abbreviation}~${e.isLecture}~${e.teacher}`;
                entryByKey.set(k, e);
            });

            const isEntryHidden = (entry) => {
                const entryKey = `${entry.day}~${entry.startTime}~${entry.abbreviation}~${entry.isLecture}~${entry.teacher}`;
                for (const selectedEntryKey of selectedEntries) {
                    if (selectedEntryKey === entryKey) continue;
                    const selectedEntry = entryByKey.get(selectedEntryKey);
                    if (selectedEntry) {
                        if (entry.abbreviation === selectedEntry.abbreviation && entry.isLecture === selectedEntry.isLecture) return true;

                        if (entry.day === selectedEntry.day) {
                            const startA = getTimeSlotIndex(entry.startTime.substring(0, 5));
                            const endA = startA + entry.duration;
                            const startB = getTimeSlotIndex(selectedEntry.startTime.substring(0, 5));
                            const endB = startB + selectedEntry.duration;

                            if (startA < endB && endA > startB) return true;
                        }
                    }
                }
                return false;
            };

            const groupedData = groupAndFilterEntries();
            const DAY_COL_WIDTH = slotWidth - 4;
            const SLOT_WIDTH = slotWidth;
            const ROW_HEIGHT = 60;
            const TABLE_WIDTH = DAY_COL_WIDTH + (timeSlots.length * SLOT_WIDTH);
            const SCREEN_WIDTH = TABLE_WIDTH + 4;

            const TABLE_MIN_WIDTH = (SLOT_MIN - 4) + (timeSlots.length * SLOT_MIN);

            return (
                <div className="flex-1 w-full mx-auto pt-4 flex flex-col items-center" style={{ maxWidth: SCREEN_WIDTH }}>
                    <Modal isOpen={isUploadModalOpen} onClose={() => setIsUploadModalOpen(false)} title="Spr√°va rozvrhu">
                        <div className="flex flex-col gap-6">

                            {/* Sekce pro automatick√Ω import */}
                            <div className="bg-gray-700/50 p-4 rounded-lg border border-gray-600">

                                <div className="flex flex-col gap-3 items-center">
                                    <div className="text-center w-full">
                                        <div className="flex justify-center gap-2 flex-wrap">
                                            {!isTouchDevice ? (
                                                <a href={bookmarkletCode} className="bg-yellow-600 hover:bg-yellow-700 text-yellow-100 font-bold py-2 px-4 rounded-full border-2 border-yellow-600 cursor-grab active:cursor-grabbing shadow-lg transition-all" title="P≈ôet√°hni mƒõ na li≈°tu z√°lo≈æek" onClick={e => e.preventDefault()}>
                                                    ‚ö° Rychl√Ω import z Edisonu
                                                </a>
                                            ) : (
                                                <button
                                                    onClick={copyToClipboard}
                                                    className={`font-bold py-2 px-4 rounded-full border-2 shadow-lg transition-all duration-300 flex items-center gap-2 ${copyStatus === 'success' ? 'bg-green-600 border-green-600 text-green-50 scale-105' :
                                                        copyStatus === 'error' ? 'bg-red-600 border-red-600 text-red-50 shake' :
                                                            'bg-gray-700 hover:bg-gray-600 border-gray-600 text-gray-200'
                                                        }`}
                                                >
                                                    {copyStatus === 'success' ? (
                                                        <><i className="fas fa-check"></i> Zkop√≠rov√°no!</>
                                                    ) : copyStatus === 'error' ? (
                                                        <><i className="fas fa-times"></i> Chyba!</>
                                                    ) : (
                                                        <><i className="fas fa-copy"></i> Zkop√≠rovat skript</>
                                                    )}
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="w-full text-left bg-gray-800/50 p-3 rounded text-xs text-gray-400">
                                        <p className="font-bold mb-1 text-gray-300">N√°vod na pou≈æit√≠:</p>
                                        {isTouchDevice ? (
                                            <ol className="list-decimal pl-4 space-y-1">
                                                <li>Kliknƒõte na <b>Zkop√≠rovat skript</b>.</li>
                                                <li>Vytvo≈ôte si v prohl√≠≈æeƒçi novou z√°lo≈æku (slo≈æka obl√≠ben√©).</li>
                                                <li>Jdƒõte do √∫pravy t√©to z√°lo≈æky a m√≠sto URL vlo≈æte zkop√≠rovan√Ω k√≥d.</li>
                                                <li>Kliknƒõte do adresn√≠ho ≈ô√°dku, klepnƒõte na z√°lo≈æku.</li>
                                                <li>P≈ôihla≈°te se do Edisonu.</li>
                                                <li>Znovu otev≈ôete z√°lo≈æku.</li>
                                                <li>Data se automaticky importuj√≠.</li>
                                                <li>Z√°lo≈æku m≈Ø≈æete odstranit.</li>

                                            </ol>
                                        ) : (
                                            <ol className="list-decimal pl-4 space-y-1">
                                                <li>P≈ôet√°hnƒõte tlaƒç√≠tko na li≈°tu obl√≠ben√Ωch z√°lo≈æek.</li>
                                                <span className="ml-2 text-gray-500 text-[0.7rem]">‚Üí pokud li≈°tu nevid√≠te, stisknƒõte <code className="bg-gray-700 px-1 py-0.5 rounded text-gray-400 font-mono text-[0.575rem]">Ctrl+Shift+B</code>/<code className="bg-gray-700 px-1 py-0.5 rounded text-gray-400 font-mono text-[0.575rem]">Cmd+Shift+B</code></span>
                                                <li>Otev≈ôete z√°lo≈æku.</li>
                                                <li>P≈ôihlaste se do Edisonu.</li>
                                                <li>Znovu otev≈ôete z√°lo≈æku.</li>
                                                <li>Data se automaticky importuj√≠.</li>
                                                <li>Z√°lo≈æku m≈Ø≈æete odstranit.</li>
                                            </ol>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="flex flex-col items-center gap-4">
                                <label className="block text-sm font-bold text-gray-300 text-center">Nahr√°n√≠m soubor≈Ø p≈ôep√≠≈°ete DEMO.</label>
                                <input id="fileInput" type="file" multiple accept=".json" onChange={handleFileUpload} className="hidden" />
                                <label htmlFor="fileInput" className="inline-flex items-center bg-blue-700 hover:bg-blue-600 text-blue-100 font-bold py-2 px-6 rounded-full border-2 border-blue-600 cursor-pointer shadow-lg transition-all hover:scale-105">
                                    <i className="fas fa-upload mr-2"></i>Vybrat soubory
                                </label>
                                <label className="block text-xs font-medium text-gray-400 text-center max-w-sm">Soubory m≈Ø≈æete nahr√°vat jednotlivƒõ, nebo v≈°echny nar√°z.<br />Nahran√© soubory se ulo≈æ√≠ do pamƒõti prohl√≠≈æeƒçe.</label>
                            </div>

                            <div className="w-full">
                                <button onClick={handleExportJpg} className="w-full bg-emerald-700 hover:bg-emerald-600 text-emerald-100 font-bold py-2 px-4 rounded-full border-2 border-emerald-600 shadow-lg flex items-center justify-center gap-2 transition-all hover:scale-105">
                                    <i className="fas fa-camera"></i> Exportovat tabulku
                                </button>
                            </div>

                            <div className="border-t border-gray-600 pt-6">
                                <button
                                    onClick={() => {
                                        if (confirmDeleteAll) {
                                            performDeleteAll();
                                        } else {
                                            setConfirmDeleteAll(true);
                                        }
                                    }}
                                    onMouseLeave={() => {
                                        if (confirmDeleteAll) setConfirmDeleteAll(false);
                                    }}
                                    className={`w-full font-bold py-2 px-4 rounded-full border-2 shadow-lg flex items-center justify-center gap-2 transition-all duration-150 hover:scale-105 ${confirmDeleteAll ? 'bg-red-800 border-red-600 text-red-100' : 'bg-red-700 hover:bg-red-600 border-red-600 text-red-100'}`}
                                >
                                    {confirmDeleteAll ? (
                                        <><i className="fas fa-trash"></i>Opravdu chcete v≈°e smazat a resetovat?</>
                                    ) : (
                                        <><i className="fas fa-trash"></i> Smazat v≈°e a resetovat</>
                                    )}
                                </button>
                            </div>

                            <div className="flex flex-col items-center pt-5 border-t border-gray-600">
                                <a className="text-blue-400 text-lg font-bold hover:text-blue-300 underline decoration-blue-400/50 hover:decoration-blue-300" target="_blank" href="https://github.com/Kuba799500/vsb_timetable_picker_html">
                                    <i className="fas fa-question-circle mr-2"></i>N√°povƒõda
                                </a>
                                <div className="text-xs text-gray-400 text-center">
                                    <p>podrobn√Ω n√°vod rychl√©ho importu &bull; z√≠sk√°n√≠ soubor≈Ø manu√°lnƒõ</p>
                                </div>
                            </div>
                        </div>
                    </Modal>

                    <Modal isOpen={exportModalOpen} onClose={() => setExportModalOpen(false)} title="Obr√°zek vygenerov√°n">
                        <div className="flex gap-4 justify-center p-2">
                            <button onClick={downloadImage} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-4 px-4 rounded-xl border-2 border-zinc-500 shadow-lg flex flex-col items-center justify-center gap-2 transition-all hover:scale-105">
                                <i className="fas fa-download text-3xl mb-1"></i>
                                <span>St√°hnout</span>
                            </button>
                            <button onClick={shareImage} className="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-xl border-2 border-blue-500 shadow-lg flex flex-col items-center justify-center gap-2 transition-all hover:scale-105">
                                <i className="fas fa-share-from-square text-3xl mb-1"></i>
                                <span>Otev≈ô√≠t v‚Ä¶</span>
                            </button>
                        </div>
                    </Modal>

                    <div className="mb-8 mt-2 px-5 w-full flex flex-col gap-3 items-center">
                        <h1 className="text-2xl font-bold text-white w-full text-center">V≈†B Timetable Picker (HTML)</h1>
                        <div className="flex flex-wrap gap-4 items-center w-full justify-center">
                            <label className="inline-flex items-center cursor-pointer bg-gray-800 [@media(hover:hover)]:hover:bg-gray-700 active:bg-gray-700 text-gray-200 border-2 border-gray-700 px-4 py-2 rounded-full transition-all shadow-lg flex-shrink-0 select-none [@media(hover:hover)]:hover:scale-105 active:scale-105">
                                <input type="checkbox" onChange={() => setShowUnusedClasses(v => !v)} checked={showUnusedClasses} className="sr-only peer" />
                                <div className="relative w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-green-600 after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
                                <span className="ml-3 font-bold text-nowrap">Zobrazit skryt√© hodiny</span>
                            </label>
                            <button onClick={() => setIsUploadModalOpen(true)} className="bg-blue-700 hover:bg-blue-600 text-blue-100 text-nowrap font-bold py-2 px-4 rounded-full border-2 border-blue-600 shadow-lg flex items-center gap-2 flex-shrink-0 transition-all hover:scale-105">
                                <i className="fas fa-cog flex-[0 0 auto]"></i><span className="flex-1 text-center px-1">Spr√°va rozvrhu</span>
                            </button>
                        </div>
                    </div>

                    <div className="mb-6 px-5 flex flex-wrap gap-3 w-full justify-center">
                        {Object.entries(subjectTypesMap).map(([name, types]) => (
                            <div key={name} className="relative group">
                                <button onClick={() => toggleSubject(name)} className={`px-4 py-3 border rounded-lg transition-all duration-200 shadow-lg ${selectedSubjects.has(name) ? "bg-gray-700 border-gray-500" : "bg-zinc-800 border-zinc-600 opacity-60 [@media(hover:hover)]:hover:opacity-100"}`}>
                                    <div className={`font-bold ${subjectColors[name]} text-white rounded mb-2 py-1 px-3 text-lg shadow-sm`}>{name}</div>
                                    <div className="flex justify-center gap-2 w-full">
                                        {types.map((type, i) => {
                                            const isSelected = Array.from(selectedEntries).some((el) => {
                                                const split = el.split("~");
                                                return split[2] === name && split[3] === (type === "C" ? "false" : "true");
                                            });
                                            return <div key={name + type + i} className={`inline-block px-2 py-0.5 text-xs rounded font-bold border ${type === "C" ? (isSelected ? "bg-blue-600 border-blue-400 text-white" : "text-blue-400 border-blue-900") : (isSelected ? "bg-red-600 border-red-400 text-white" : "text-red-400 border-red-900")}`}>{type}</div>
                                        })}
                                    </div>
                                </button>
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirmDeleteSubject === name) {
                                            performDeleteSubject(name);
                                        } else {
                                            setConfirmDeleteSubject(name);
                                        }
                                    }}
                                    onMouseLeave={() => {
                                        // collapse confirmation when mouse leaves the button
                                        if (confirmDeleteSubject === name) setConfirmDeleteSubject(null);
                                    }}
                                    className={`absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full flex items-center justify-center shadow-md text-xs transition-all duration-150 ${confirmDeleteSubject === name ? 'px-3 py-1 rounded-full w-auto opacity-100' : `w-6 h-6 ${selectedSubjects.has(name) ? 'opacity-100' : 'opacity-0 [@media(hover:hover)]:group-hover:opacity-100'}`}`}>
                                    {confirmDeleteSubject === name ? 'Smazat?' : <i className="fas fa-times"></i>}
                                </button>
                            </div>
                        ))}
                    </div>



                    <div className="w-full overflow-x-auto">
                        <div className="inline-flex">
                            <div className="flex flex-col">
                                <div id="timetable-content" className="bg-[#242424] inline-block">
                                    <div className="flex bg-gray-800 border-b-2 border-gray-600" style={{ width: TABLE_WIDTH }}>
                                        <div className="flex-none bg-gray-700 flex items-center justify-center font-bold text-gray-400 border-r border-gray-600" style={{ width: DAY_COL_WIDTH }}>Den</div>
                                        {timeSlots.map((slot, index) => (
                                            <div key={slot} className={`flex-none h-full py-2 text-center text-xs text-gray-400 border-r border-gray-700/50 flex flex-col justify-center ${index % 2 ? "bg-gray-700/30" : "bg-gray-800"}`} style={{ width: SLOT_WIDTH }}>
                                                {slot.split("-").map((part, i) => <div key={i}>{part}</div>)}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="relative flex flex-col gap-1 select-none" style={{ minWidth: TABLE_WIDTH }}>
                                        {currentTimePosition && (
                                            <div className="absolute w-0.5 bg-red-500 z-20 pointer-events-none shadow-[0_0_8px_rgba(239,68,68,0.8)] no-export" style={{ left: `${currentTimePosition + DAY_COL_WIDTH}px`, height: 'calc(100% + 3.5rem)' }} />
                                        )}

                                        {["Pondƒõl√≠", "√öter√Ω", "St≈ôeda", "ƒåtvrtek", "P√°tek"].map((day) => {
                                            const rawEntries = groupedData[day] || [];
                                            const { items: positionedEntries, rowCount } = calculateLayout(rawEntries);

                                            return (
                                                <div key={day} className="relative bg-gray-800 border-b border-gray-700 grid"
                                                    style={{
                                                        width: TABLE_WIDTH,
                                                        gridTemplateColumns: `${DAY_COL_WIDTH}px repeat(${timeSlots.length}, ${SLOT_WIDTH}px)`,
                                                        gridTemplateRows: `repeat(${rowCount}, ${ROW_HEIGHT}px)`
                                                    }}>

                                                    <div className="col-start-1 flex items-center justify-center bg-sky-900 text-sky-200 font-bold text-lg border-r border-gray-600 z-10"
                                                        style={{ gridRow: `1 / span ${rowCount}` }}>
                                                        {day.substring(0, 2)}
                                                    </div>

                                                    <div className="absolute inset-0 pointer-events-none z-0">
                                                        {timeSlots.map((_, i) => (
                                                            <div key={i} className="absolute top-0 bottom-0 border-r border-gray-700/40" style={{ left: DAY_COL_WIDTH + ((i + 1) * SLOT_WIDTH) }}></div>
                                                        ))}
                                                    </div>

                                                    {positionedEntries.map((subject, index) => {
                                                        const key = `${subject.day}~${subject.startTime}~${subject.abbreviation}~${subject.isLecture}~${subject.teacher}`;
                                                        const isSelected = selectedEntries.has(key);
                                                        const colStart = getTimeSlotIndex(subject.startTime.substring(0, 5));
                                                        // Unique React key: use activityId if available to prevent duplicate key issues
                                                        const reactKey = subject.activityId ? `${subject.abbreviation}-${subject.activityId}` : `${key}-${index}`;

                                                        return (
                                                            <div
                                                                key={reactKey}
                                                                className={`
                                                    relative z-10 m-[2px] border-2 rounded-md cursor-pointer overflow-hidden text-xs
                                                    transition-all duration-150 hover:z-20 hover:shadow-xl hover:scale-105
                                                    ${showUnusedClasses && "select-none"} 
                                                    ${subject.isLecture ? "border-red-800 bg-red-900/80 hover:bg-red-800" : "border-sky-800 bg-sky-900/80 hover:bg-sky-800"} 
                                                    ${isSelected ? `!border-lime-400 !bg-opacity-100 shadow-md` : ""} 
                                                    ${isEntryHidden(subject) && !isSelected ? "opacity-30 grayscale" : ""}
                                                    ${isSelected && subject.isLecture ? "!bg-red-700" : ""} 
                                                    ${isSelected && !subject.isLecture ? "!bg-sky-700" : ""}
                                                `}
                                                                style={{
                                                                    gridColumnStart: colStart,
                                                                    gridColumnEnd: colStart + subject.duration,
                                                                    gridRow: subject.visualRowIndex + 1
                                                                }}

                                                                onClick={(e) => {
                                                                    if (isLongPress.current) return;
                                                                    if (!isEntryHidden(subject)) {
                                                                        pickClass(subject);
                                                                    }
                                                                }}

                                                                onContextMenu={(e) => {
                                                                    e.preventDefault();
                                                                    setTooltip({
                                                                        x: e.clientX,
                                                                        y: e.clientY,
                                                                        teacher: subject.teacherFull,
                                                                        room: subject.roomId,
                                                                        isTouch: false
                                                                    });
                                                                }}

                                                                onTouchStart={(e) => touchHandlers.onTouchStart(e, subject)}
                                                                onTouchEnd={touchHandlers.onTouchEnd}
                                                                onTouchMove={touchHandlers.onTouchMove}


                                                            >
                                                                <div className="pl-0.5 py-0.5 pr-2 flex flex-col h-full">

                                                                    <div className="flex justify-between items-start">
                                                                        <span className={`font-bold px-1.5 py-0.5 rounded text-[10px] text-white ${subjectColors[subject.abbreviation]} ${selectedSubjects.has(subject.abbreviation)}`}>
                                                                            {subject.abbreviation}
                                                                        </span>
                                                                        <span className="text-[10px] font-mono opacity-70" title="Kapacita">{subject.capacity}</span>
                                                                        <span className="font-mono opacity-70">{subject.isLecture ? "P" : "C"}</span>
                                                                    </div>
                                                                    <div className="flex-1 flex items-center justify-center"><span className="pl-1.5 font-semibold truncate" title={subject.teacher}>{subject.teacher}</span></div>

                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="h-14 w-full shrink-0"></div>
                            </div>
                            <div style={{ width: TABLE_WIDTH === TABLE_MIN_WIDTH ? 20 : 0 }} className="shrink-0"></div>
                        </div>
                    </div>
                    {tooltip && (
                        <>
                            <div onClick={closeTooltip} style={{
                                position: 'fixed',
                                inset: 0,
                                zIndex: 95,
                                backgroundColor: '#00000022',
                                cursor: 'default',
                                touchAction: 'none',
                                backdropFilter: 'blur(0.5px)',
                                WebkitBackdropFilter: 'blur(0.5px)',
                                animation: isClosing ? 'fadeOut 0.1s ease-out forwards' : 'fadeIn 0.2s ease-out forwards'
                            }} />
                            <div ref={tooltipRef} style={{
                                position: 'fixed',
                                left: Math.max(10, Math.min(tooltip.isTouch ? tooltip.x - 150 : tooltip.x + 15, window.innerWidth - 310)),
                                backgroundColor: '#1f2937', // Tmavƒõ ≈°ed√° (lad√≠ s designem)
                                border: '1px solid #4b5563',
                                padding: '12px',
                                borderRadius: '8px',
                                zIndex: 100, // Aby bylo nad v≈°√≠m ostatn√≠m
                                boxShadow: '0 4px 6px rgba(0,0,0,0.5)',
                                color: 'white',
                                width: '300px',
                                pointerEvents: 'auto', // Aby ≈°lo kliknout na zav√≠rac√≠ k≈ô√≠≈æek
                                touchAction: 'none',
                                animation: isClosing ? 'modalOut 0.1s ease-in forwards' : 'modalIn 0.2s ease-out forwards'
                            }}>
                                <div className="font-bold text-xs text-gray-400 mb-1 uppercase tracking-wider">Vyuƒçuj√≠c√≠</div>
                                <div className="text-sm font-medium">{tooltip.teacher}</div>

                                <div className="font-bold text-xs text-gray-400 mt-3 mb-1 uppercase tracking-wider">M√≠stnost</div>
                                <div className="text-sm font-medium">
                                    {tooltip.roomUrl ? (
                                        <a href={tooltip.roomUrl} target="_blank" rel="noreferrer" className="text-sky-400 hover:text-sky-300 underline decoration-sky-400/50 hover:decoration-sky-300">
                                            {tooltip.room} <i className="fas fa-external-link-alt text-[10px] ml-1 opacity-70"></i>
                                        </a>
                                    ) : tooltip.room}
                                </div>


                                {/* Tlaƒç√≠tko pro zav≈ôen√≠ */}
                                <button
                                    onClick={closeTooltip}
                                    className="absolute -top-2 -right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md transition-colors"
                                >
                                    <i className="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        </>
                    )}

                    {notification && (
                        <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>

</html>